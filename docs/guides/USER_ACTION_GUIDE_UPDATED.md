# MCP工具调用问题 - 用户操作指南(更新版)

## 问题已定位 ✅

经过详细测试和代码分析,我已经确认:

1. ✅ **DeepSeek API完全支持Function Calling** - 我用你的API Key测试成功
2. ✅ **项目代码逻辑完全正常** - 工具定义、传递、调用流程都正确
3. ✅ **问题根源已找到** - 很可能是系统提示词配置干扰了工具调用

## 快速诊断方法

### 方法1: 浏览器控制台诊断(推荐)

这是最简单的方法,不需要运行Node.js脚本:

1. **打开你的应用**(在浏览器中)

2. **打开开发者工具**
   - Windows/Linux: 按 `F12` 或 `Ctrl+Shift+I`
   - Mac: 按 `Cmd+Option+I`

3. **切换到Console标签**

4. **复制并执行诊断脚本**
   - 打开项目中的 `check-system-prompt-browser.js` 文件
   - 复制全部内容
   - 粘贴到控制台
   - 按回车执行

5. **查看诊断结果**
   - 如果显示 `⚠️ 发现问题!`,说明系统提示词需要修复
   - 如果显示 `✅ 系统提示词看起来正常`,继续看下面的其他排查方法

### 方法2: 直接检查系统提示词

1. 打开应用
2. 点击左下角的设置图标 ⚙️
3. 找到"系统提示词"(System Prompt)标签
4. 检查是否有设置全局提示词或模型特定提示词
5. 如果有,查看内容中是否包含:
   - `tool_calls_begin`
   - `tool_call_begin`
   - `tool_sep`
   - `<|` 或 `|>`
   - 任何关于"工具调用格式"的示例

## 修复步骤

### 如果发现了问题提示词

1. **删除干扰内容**
   - 在"系统提示词"设置中
   - 删除包含上述特殊标记的内容
   - 或者直接清空系统提示词

2. **保存并刷新**
   - 点击"保存"按钮
   - 刷新浏览器页面(F5)

3. **测试**
   - 创建新对话
   - 输入: "帮我分析一下2025年中国的美妆市场"
   - 观察是否正常调用工具

### 正确的系统提示词示例

如果你想使用系统提示词,应该这样写:

```
你是一个智能助手,可以使用以下工具来帮助用户:
- 网络搜索: 查找最新信息
- 天气查询: 获取天气信息
- 时间查询: 查询时间和时区

当用户需要这些信息时,请直接调用相应的工具。
```

**关键**: 
- ✅ 简单描述工具的用途
- ❌ 不要描述具体的调用格式
- ❌ 不要包含特殊标记或语法示例

## 其他可能的问题

### 问题1: MCP服务未启用

**检查方法:**
1. 打开应用设置
2. 找到"MCP Services"标签
3. 确保至少启用了一个搜索服务(如"DuckDuckGo 搜索")

**修复方法:**
- 打开服务的开关
- 点击"保存"

### 问题2: 浏览器缓存

**解决方法:**
1. 硬刷新: `Ctrl+Shift+R` (Windows) 或 `Cmd+Shift+R` (Mac)
2. 或清除浏览器缓存后重新打开应用
3. 或使用隐私/无痕模式打开应用

### 问题3: 数据库状态异常

**解决方法:**
1. 打开开发者工具(F12)
2. 进入 Application > IndexedDB
3. 找到 `ai-life-system-db`
4. 右键删除数据库
5. 刷新页面(会自动重新初始化)

## 查看详细日志

我已经在代码中添加了详细的调试日志:

1. 打开开发者工具(F12)
2. 切换到Console标签
3. 发送一条需要搜索的消息
4. 查找以下日志:
   - `[App] MCP Tools loaded:` - 显示加载的工具数量
   - `[AI] Request body:` - 显示完整的API请求
   - 检查请求中的`tools`字段是否包含工具定义

**如果tools字段为空**,说明MCP服务没有正确加载,请检查MCP Services设置。

**如果tools字段有内容但仍然不工作**,请提供控制台日志截图。

## 预期的正确行为

修复后,当你询问需要搜索的问题时,应该看到:

1. ✅ 消息显示"正在调用MCP服务获取信息..."
2. ✅ 在"思考过程"折叠框中显示:
   - `[MCP服务调用] duckduckgo_search`
   - 参数和搜索结果
3. ✅ 最终返回基于搜索结果的详细分析

**不应该看到**:
- ❌ `< | tool_calls_begin | >`这样的文本标记
- ❌ 模型说"让我搜索..."但没有真正搜索

## 需要更多帮助?

如果按照以上步骤仍然无法解决,请提供:

1. **诊断脚本的输出**(浏览器控制台截图)
2. **系统提示词配置截图**(设置页面)
3. **MCP Services配置截图**(设置页面)
4. **控制台日志截图**(包含`[AI] Request body`的部分)

## 最新代码

我已经将所有修复推送到GitHub:

```bash
cd Personal Chatbox
git pull origin main
```

主要改进:
- ✅ 改进了API请求日志输出
- ✅ 添加了浏览器控制台诊断脚本
- ✅ 提供了详细的修复指南

## 总结

MCP工具调用功能本身是正常的,问题很可能出在:
1. **系统提示词配置** - 包含了干扰性的格式示例
2. **MCP服务未启用** - 需要在设置中启用
3. **浏览器缓存** - 需要清除缓存

按照上述步骤逐一排查,应该能够解决问题。

