# Phase 1.1: 智能搜索与过滤 - 使用指南

## 🎉 功能介绍

智能搜索功能已成功集成到 Personal Chatbox！现在你可以：
- 🔍 快速搜索对话标题和内容
- 📅 按日期范围过滤对话
- 🔄 自定义排序方式
- ⌨️ 使用快捷键快速访问
- 📝 查看搜索历史记录

---

## 🚀 快速开始

### 1. 运行数据库迁移

**首次使用前必须执行！**

```bash
# 方法1: 使用便捷脚本（推荐）
./scripts/run-db-migration.sh

# 方法2: 直接运行 Node 脚本
node server/db/run-migration.cjs

# 方法3: 使用 npm 命令（需要先添加到 package.json）
npm run db:migrate
```

迁移会自动：
- 创建全文搜索虚拟表
- 为现有对话建立索引
- 设置自动同步触发器
- 优化查询性能

### 2. 重启服务

```bash
# 停止现有服务
# 然后重新启动
./start.sh
```

---

## 📖 功能使用

### 搜索栏

#### 位置
- 在侧边栏顶部，"新对话"按钮下方
- 始终可见，方便快速访问

#### 基础搜索
1. **直接输入**：在搜索框输入关键词
2. **实时搜索**：输入时自动过滤对话列表
3. **搜索范围**：
   - 对话标题
   - 消息内容

#### 快捷键
- **⌘K** (Mac) 或 **Ctrl+K** (Windows/Linux): 聚焦搜索框
- **Enter**: 执行搜索
- **Esc**: 取消搜索，关闭搜索历史

#### 搜索历史
- 自动保存最近 10 次搜索
- 点击历史记录快速重新搜索
- 悬停显示删除按钮
- "清空"按钮清除所有历史

---

### 高级过滤

#### 打开过滤面板
- 点击搜索栏右侧的 **过滤器图标** (漏斗图标)
- 有激活过滤时，图标会高亮显示小红点

#### 日期范围过滤

**手动选择**
1. 点击"开始日期"或"结束日期"
2. 在日历中选择日期
3. 结束日期不能早于开始日期

**快捷选择**
- **今天**: 只显示今天创建的对话
- **最近7天**: 显示过去一周的对话
- **最近30天**: 显示过去一个月的对话
- **清除日期**: 移除日期过滤

#### 排序选项

**排序方式**
- **按时间**: 根据创建/更新时间排序（默认）
- **按相关度**: 根据搜索匹配程度排序（仅在有搜索关键词时有效）
- **按消息数**: 根据对话中的消息数量排序

**排序方向**
- **降序**: 从大到小（默认）
- **升序**: 从小到大

#### 应用和重置
- **应用过滤**: 执行过滤并关闭面板
- **重置**: 清除所有过滤条件

---

## 💡 使用技巧

### 1. 组合使用
```
搜索关键词 + 日期范围 + 排序
```
例如：搜索"API"，限制最近7天，按消息数降序

### 2. 精确搜索
- 搜索完整的词组或句子
- 关键词会在标题和内容中匹配

### 3. 快速清除
- 搜索框右侧的 **X** 按钮：清除搜索词
- 空结果页的"清除筛选"链接：重置所有过滤

### 4. 无结果处理
- 检查拼写
- 尝试更简短的关键词
- 调整日期范围
- 点击"清除筛选"重新开始

---

## 🎨 界面说明

### 搜索结果展示
- **正常对话列表**: 显示匹配的对话
- **空状态**: 友好提示 + 清除筛选按钮
- **高亮**: 匹配的关键词会在未来版本中高亮显示

### 视觉反馈
- **过滤器激活**: 过滤器按钮显示蓝色背景 + 小红点
- **搜索中**: 输入框显示加载状态（未来版本）
- **结果数量**: 显示在列表顶部（未来版本）

---

## 🔧 技术细节

### 搜索机制
- **前端搜索**: 当前使用本地 JavaScript 过滤
- **后端 FTS**: SQLite 全文搜索已准备，可切换使用
- **缓存**: 后端搜索结果缓存 1 分钟

### 性能优化
- **防抖**: 输入后 300ms 才执行搜索
- **useMemo**: React 优化，避免重复计算
- **虚拟滚动**: 大量结果时的优化（未来版本）

### 数据持久化
- **搜索历史**: 存储在 localStorage
- **过滤器状态**: 会话期间保持，刷新后重置

---

## 🐛 常见问题

### Q: 搜索不工作？
**A**: 检查以下步骤：
1. 确认已运行数据库迁移
2. 重启后端服务
3. 清除浏览器缓存并刷新页面
4. 检查浏览器控制台是否有错误

### Q: 搜索历史不显示？
**A**:
- 确认浏览器支持 localStorage
- 检查浏览器隐私设置
- 尝试手动清除历史后重新搜索

### Q: 过滤器不生效？
**A**:
- 点击"应用过滤"按钮
- 确认日期范围设置正确
- 尝试点击"重置"后重新设置

### Q: 中文搜索有问题？
**A**:
- 当前版本完全支持中文
- SQLite FTS 使用 unicode61 分词器
- 如有问题，请提交 Issue

---

## 🎯 使用场景

### 场景1: 查找历史对话
```
1. 按 ⌘K 打开搜索
2. 输入关键词（如 "API 设计"）
3. 浏览搜索结果
4. 点击对话查看详情
```

### 场景2: 回顾最近工作
```
1. 点击过滤器按钮
2. 选择"最近7天"
3. 按消息数降序排序
4. 查看最活跃的对话
```

### 场景3: 查找特定时期的对话
```
1. 点击过滤器按钮
2. 设置开始和结束日期
3. 应用过滤
4. 逐个查看结果
```

---

## 📊 数据说明

### 迁移内容
```sql
-- 创建的表和索引
- conversations_fts (虚拟表)
- idx_conversations_created_at (索引)
- idx_conversations_user_created (索引)
- idx_messages_conversation (索引)

-- 触发器
- conversations_fts_insert
- conversations_fts_update
- conversations_fts_delete
- messages_fts_sync (3个)
```

### 迁移安全性
- ✅ 使用事务，失败自动回滚
- ✅ 不影响现有数据
- ✅ 可重复执行（幂等性）
- ✅ 自动处理现有对话

---

## 🔮 未来优化

### 计划中的功能
- [ ] 搜索结果关键词高亮
- [ ] 搜索结果数量统计
- [ ] 保存搜索条件为快捷方式
- [ ] 智能搜索建议
- [ ] 语义搜索（AI 辅助）
- [ ] 搜索结果导出
- [ ] 按标签过滤（Phase 1.4 后）
- [ ] 按模型过滤

---

## 📞 反馈与支持

### 遇到问题？
1. 查看控制台错误信息
2. 检查 `logs/backend.log`
3. 提交 Issue 到 GitHub

### 功能建议？
欢迎在 GitHub 提出你的想法！

---

**文档更新**: 2025-10-15
**功能版本**: Phase 1.1
**状态**: ✅ 已完成并测试
