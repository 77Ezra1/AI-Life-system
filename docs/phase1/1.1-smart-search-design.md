# Phase 1.1: 智能搜索与过滤 - 详细设计

## 📋 功能概述

为 Personal Chatbox 添加强大的搜索功能，让用户快速找到历史对话。

## 🎯 核心功能

### 1. 搜索功能
- 全文搜索（标题 + 消息内容）
- 实时搜索（输入时即时显示结果）
- 搜索结果高亮
- 搜索历史记录

### 2. 高级过滤
- 日期范围过滤
- 模型过滤（按使用的 AI 模型）
- 标签过滤（Phase 1.4 完成后）
- 消息数量过滤

### 3. 排序功能
- 按相关度排序
- 按时间排序（最新/最旧）
- 按消息数量排序

## 🏗️ 架构设计

### 前端组件结构
```
src/components/sidebar/
├── SearchBar.jsx              # 搜索输入框
├── AdvancedFilter.jsx         # 高级过滤器面板
├── SearchResults.jsx          # 搜索结果展示
└── Sidebar.jsx                # 修改：集成搜索功能
```

### 后端 API
```
GET /api/conversations/search
Query Parameters:
  - q: 搜索关键词
  - from: 开始日期 (YYYY-MM-DD)
  - to: 结束日期 (YYYY-MM-DD)
  - model: 模型筛选
  - sort: 排序方式 (relevance/date/messages)
  - order: 排序方向 (asc/desc)
  - limit: 返回数量限制
  - offset: 分页偏移
```

### 数据流
```
用户输入 → 前端防抖 (300ms) → API 请求 →
后端搜索 (SQLite FTS) → 返回结果 → 前端展示 + 高亮
```

## 🗄️ 数据库改动

### 启用 SQLite FTS（全文搜索）

```sql
-- 创建虚拟表用于全文搜索
CREATE VIRTUAL TABLE conversations_fts USING fts5(
  id UNINDEXED,
  title,
  content,
  tokenize='porter unicode61'
);

-- 创建触发器：新增对话时同步到 FTS 表
CREATE TRIGGER conversations_fts_insert AFTER INSERT ON conversations
BEGIN
  INSERT INTO conversations_fts(id, title, content)
  SELECT
    NEW.id,
    NEW.title,
    COALESCE(
      (SELECT GROUP_CONCAT(content, ' ')
       FROM messages
       WHERE conversation_id = NEW.id),
      ''
    );
END;

-- 创建触发器：更新对话时同步到 FTS 表
CREATE TRIGGER conversations_fts_update AFTER UPDATE ON conversations
BEGIN
  UPDATE conversations_fts
  SET title = NEW.title
  WHERE id = NEW.id;
END;

-- 创建触发器：删除对话时清理 FTS 表
CREATE TRIGGER conversations_fts_delete AFTER DELETE ON conversations
BEGIN
  DELETE FROM conversations_fts WHERE id = OLD.id;
END;

-- 创建触发器：消息变化时更新 FTS 内容
CREATE TRIGGER messages_fts_sync AFTER INSERT ON messages
BEGIN
  UPDATE conversations_fts
  SET content = (
    SELECT GROUP_CONCAT(content, ' ')
    FROM messages
    WHERE conversation_id = NEW.conversation_id
  )
  WHERE id = NEW.conversation_id;
END;
```

### 索引优化

```sql
-- 为常用查询字段添加索引
CREATE INDEX IF NOT EXISTS idx_conversations_created_at
  ON conversations(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_conversations_user_created
  ON conversations(user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_messages_conversation
  ON messages(conversation_id, timestamp);
```

## 💻 前端实现

### 1. SearchBar 组件

**功能**：
- 搜索输入框
- 实时搜索（防抖）
- 清空按钮
- 搜索历史下拉

**状态管理**：
```javascript
const [searchQuery, setSearchQuery] = useState('')
const [searchHistory, setSearchHistory] = useState([])
const [isSearching, setIsSearching] = useState(false)
```

### 2. AdvancedFilter 组件

**功能**：
- 日期选择器（使用 react-day-picker）
- 模型多选（Checkbox）
- 排序选项（Select）
- 重置按钮

**状态管理**：
```javascript
const [filters, setFilters] = useState({
  dateFrom: null,
  dateTo: null,
  models: [],
  sort: 'relevance',
  order: 'desc'
})
```

### 3. 搜索结果展示

**功能**：
- 结果列表（复用 ConversationItem）
- 关键词高亮
- 无结果提示
- 加载状态

## 🔧 技术实现细节

### 前端搜索优化

1. **防抖处理**
```javascript
import { useDebouncedCallback } from 'use-debounce'

const debouncedSearch = useDebouncedCallback(
  (query) => {
    performSearch(query)
  },
  300 // 300ms 延迟
)
```

2. **关键词高亮**
```javascript
const highlightText = (text, query) => {
  if (!query) return text
  const regex = new RegExp(`(${query})`, 'gi')
  return text.replace(regex, '<mark>$1</mark>')
}
```

3. **搜索历史持久化**
```javascript
// 使用 localStorage 存储
const saveSearchHistory = (query) => {
  const history = JSON.parse(localStorage.getItem('searchHistory') || '[]')
  const updated = [query, ...history.filter(q => q !== query)].slice(0, 10)
  localStorage.setItem('searchHistory', JSON.stringify(updated))
}
```

### 后端搜索实现

1. **FTS 查询**
```javascript
// 使用 SQLite FTS5 进行全文搜索
const searchConversations = (userId, query, filters) => {
  let sql = `
    SELECT
      c.id,
      c.title,
      c.created_at,
      c.updated_at,
      COUNT(m.id) as message_count,
      snippet(conversations_fts, 1, '<mark>', '</mark>', '...', 50) as snippet
    FROM conversations c
    LEFT JOIN conversations_fts fts ON c.id = fts.id
    LEFT JOIN messages m ON c.id = m.conversation_id
    WHERE c.user_id = ?
  `

  const params = [userId]

  if (query) {
    sql += ` AND fts.conversations_fts MATCH ?`
    params.push(query)
  }

  // 添加日期过滤
  if (filters.dateFrom) {
    sql += ` AND c.created_at >= ?`
    params.push(filters.dateFrom)
  }

  if (filters.dateTo) {
    sql += ` AND c.created_at <= ?`
    params.push(filters.dateTo)
  }

  // 分组
  sql += ` GROUP BY c.id`

  // 排序
  if (filters.sort === 'relevance' && query) {
    sql += ` ORDER BY rank`
  } else if (filters.sort === 'date') {
    sql += ` ORDER BY c.created_at ${filters.order}`
  } else if (filters.sort === 'messages') {
    sql += ` ORDER BY message_count ${filters.order}`
  }

  // 分页
  sql += ` LIMIT ? OFFSET ?`
  params.push(filters.limit || 20, filters.offset || 0)

  return db.all(sql, params)
}
```

2. **缓存策略**
```javascript
// 使用简单的内存缓存
const searchCache = new Map()
const CACHE_TTL = 60000 // 1分钟

const getCachedSearch = (cacheKey) => {
  const cached = searchCache.get(cacheKey)
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data
  }
  return null
}
```

## 🎨 UI/UX 设计

### 搜索栏样式
- 图标：放大镜 (Search)
- 位置：Sidebar 顶部，对话列表上方
- 样式：Apple 风格圆角输入框
- 快捷键：Cmd/Ctrl + K 聚焦搜索框

### 高级过滤器
- 展开/收起按钮（Filter 图标）
- 面板：Popover 或 Collapsible
- 样式：简洁的表单布局

### 搜索结果
- 高亮：黄色背景标记
- 摘要：显示匹配的上下文片段
- 空状态：友好的提示 + 搜索建议

## 📱 响应式设计

### 移动端适配
- 搜索栏：全宽显示
- 过滤器：底部抽屉展示
- 结果列表：单列布局

## ⚡ 性能优化

1. **防抖和节流**：避免频繁 API 请求
2. **虚拟列表**：大量结果时使用虚拟滚动
3. **懒加载**：结果分页加载
4. **FTS 索引**：利用 SQLite 全文搜索加速
5. **缓存**：相同搜索复用结果

## 🧪 测试用例

### 功能测试
1. 搜索空字符串 → 显示所有对话
2. 搜索关键词 → 返回匹配结果
3. 使用过滤器 → 正确筛选
4. 排序功能 → 结果正确排序
5. 分页功能 → 加载更多结果

### 边界测试
1. 特殊字符搜索
2. 超长关键词
3. 无结果情况
4. 网络错误处理

## 📦 依赖包

```json
{
  "dependencies": {
    "use-debounce": "^10.0.0",  // 防抖 Hook
    "date-fns": "^4.1.0"        // 已安装，用于日期处理
  }
}
```

## 🚀 实施步骤

1. ✅ 创建设计文档
2. ⏳ 数据库迁移（添加 FTS 表和触发器）
3. ⏳ 后端搜索 API 实现
4. ⏳ 前端 SearchBar 组件
5. ⏳ 前端 AdvancedFilter 组件
6. ⏳ 集成到 Sidebar
7. ⏳ 测试和优化
8. ⏳ 文档更新

## 📝 后续优化

- [ ] 搜索建议（根据历史和热门搜索）
- [ ] 搜索结果统计（显示匹配数量）
- [ ] 导出搜索结果
- [ ] 保存搜索条件为快捷方式
- [ ] AI 辅助搜索（语义搜索）

---

**设计完成时间**: 2025-10-15
**预计实施时间**: 1 天
**技术难度**: ⭐⭐⭐

