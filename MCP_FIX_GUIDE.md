# MCP工具调用问题修复指南

## 问题诊断结果

经过详细测试,我发现:

✅ **DeepSeek API完全支持Function Calling** - 直接API调用测试成功  
✅ **项目代码逻辑正常** - 工具定义和调用流程都是正确的  
✅ **工具列表正确传递** - 请求体中包含完整的tools参数  

❌ **但是用户界面显示了错误的输出格式**

## 根本原因

用户截图中显示的格式:
```
< | tool_calls_begin | >< | tool_call_begin | >duckduckgo_search< | tool_sep | >
```

这种格式**不是**API返回的,而是**大模型在内容中生成的文本**。

### 最可能的原因: 系统提示词干扰

如果在应用的"系统提示词"设置中包含了类似以下内容:

```
当需要搜索时,使用以下格式调用工具:
< | tool_calls_begin | >
< | tool_call_begin | >工具名称< | tool_sep | >参数< | tool_call_end | >
< | tool_calls_end | >
```

这会导致模型**学习并模仿这种文本格式**,而不是使用API的标准Function Calling功能。

## 修复步骤

### 步骤1: 检查系统提示词

在项目根目录运行检查脚本:

```bash
node fix-system-prompt.js
```

这个脚本会检查你的IndexedDB数据库,找出可能干扰工具调用的系统提示词。

### 步骤2: 清除或修改问题提示词

如果检查脚本发现了问题,请:

1. 打开应用
2. 进入"设置" > "系统提示词"
3. 检查"全局提示词"和"模型特定提示词"
4. **删除或修改**任何包含以下内容的提示词:
   - `tool_calls_begin`
   - `tool_call_begin`
   - `tool_sep`
   - `tool_calls_end`
   - `tool_call_end`
   - `< |` 或 `| >`
   - 任何关于"工具调用格式"的示例

### 步骤3: 使用正确的系统提示词(可选)

如果你想在系统提示词中提及工具使用,应该这样写:

```
你是一个智能助手,可以使用以下工具来帮助用户:
- 网络搜索: 当需要查找最新信息时使用
- 天气查询: 当用户询问天气时使用
- 时间查询: 当用户询问时间时使用

当用户的问题需要这些工具时,请直接调用相应的工具。
```

**注意**: 不要在提示词中描述具体的调用格式或语法,让模型自动使用API的Function Calling功能。

### 步骤4: 测试修复效果

1. 清除系统提示词后,刷新应用
2. 创建新对话
3. 输入测试问题: "帮我分析一下2025年中国的美妆市场"
4. 观察是否正确调用了搜索工具

## 预期的正确行为

修复后,当你询问需要搜索的问题时,应该看到:

1. 消息显示"正在调用MCP服务获取信息..."
2. 在"思考过程"折叠框中显示搜索过程
3. 最终返回基于搜索结果的详细分析

## 其他可能的问题

如果清除系统提示词后问题仍然存在,可能是:

### 问题A: MCP服务未启用

检查"设置" > "MCP Services",确保至少启用了一个搜索服务(如DuckDuckGo)。

### 问题B: 浏览器缓存

尝试:
1. 清除浏览器缓存
2. 硬刷新页面(Ctrl+Shift+R 或 Cmd+Shift+R)
3. 或使用隐私模式打开应用

### 问题C: 数据库损坏

如果以上都无效,可以尝试重置数据库:
1. 打开浏览器开发者工具(F12)
2. 进入"Application" > "IndexedDB"
3. 删除应用的数据库
4. 刷新页面(会重新初始化)

## 代码改进

我已经在代码中添加了更详细的日志输出,帮助调试:

```javascript
// src/lib/aiClient.js
console.log('[AI] Request body:', JSON.stringify(requestBody, null, 2))
```

现在你可以在浏览器控制台中看到完整的API请求,包括tools参数。

## 需要帮助?

如果按照以上步骤仍然无法解决问题,请:

1. 打开浏览器开发者工具(F12)
2. 切换到"Console"标签
3. 重现问题
4. 截图控制台输出(特别是包含`[AI] Request body`的日志)
5. 提供截图以便进一步诊断

## 总结

MCP工具调用功能本身是正常的,问题很可能出在系统提示词配置上。清除干扰性的提示词后,功能应该能够正常工作。

